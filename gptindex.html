<!--
Agent Avana ‚Äî Single-file SPA frontend (index.html)

Fixed issues in this revision:
- Resolved `ReferenceError: Cannot access 'mockPolicies' before initialization` by moving mock data initialization before the router is first executed.
- Replaced fragile `e.target` usage when reading dataset ids with `e.currentTarget` to avoid clicks on nested nodes causing undefined ids.
- Removed duplicate early router() invocation; router is now called once after all render functions are defined.
- Added a small smoke test block that runs basic assertions in the browser console to help catch regressions quickly.
- Kept original behavior & mock endpoints; kept 'AGENT AVANA' branding and overlay/chat features.

How to use:
- Open this file in a modern browser to preview. The page uses client-side mocks.
- Replace mock fetch calls with your backend endpoints (see comments in code for recommended endpoints).

-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AGENT AVANA ‚Äî Legal Contracts Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); }
    .card-hover{ transition: transform .18s ease, box-shadow .18s ease }
    .card-hover:hover{ transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.08) }
    .no-select{ user-select:none }
    .progress-bg{ background: linear-gradient(90deg,#10b981,var(--g)); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-900">
  <div id="app" class="flex h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-72 bg-white border-r hidden md:block">
      <div class="p-4 flex items-center gap-3">
        <div class="rounded-full bg-rose-600 text-white w-10 h-10 flex items-center justify-center font-bold">AA</div>
        <div>
          <div class="font-semibold">AGENT AVANA</div>
          <div class="text-xs text-slate-500">Legal Contracts Platform</div>
        </div>
      </div>
      <nav class="mt-4 px-2 space-y-1">
        <a href="#/" class="block p-3 rounded-lg hover:bg-slate-50 card-hover">üè† Home</a>
        <a href="#/verify" class="block p-3 rounded-lg hover:bg-slate-50 card-hover">üîé Verification</a>
        <a href="#/notifications" class="block p-3 rounded-lg hover:bg-slate-50 card-hover">üîî Notifications</a>
        <a href="#/settings" class="block p-3 rounded-lg hover:bg-slate-50 card-hover">‚öôÔ∏è Settings</a>
      </nav>
      <div class="p-4 border-t text-sm text-slate-600">
        <div class="flex items-center justify-between">
          <div>Role</div>
          <select id="roleSelect" class="border rounded px-2 py-1 text-sm">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
    </aside>

    <!-- Main area -->
    <div class="flex-1 flex flex-col">
      <!-- Topbar -->
      <header class="flex items-center justify-between p-4 border-b bg-white">
        <div class="flex items-center gap-4">
          <button id="mobileMenu" class="md:hidden p-2 rounded bg-slate-100">‚ò∞</button>
          <div class="text-lg font-semibold">AGENT AVANA</div>
          <div class="hidden sm:block ml-6">
            <input id="search" class="border rounded-lg px-3 py-2 w-96" placeholder="Search contracts, policies, clauses..." />
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-sm text-slate-500">EN ‚ñº</div>
          <div class="relative">
            <button id="notifBtn" class="p-2 rounded-full bg-slate-100">üîî</button>
            <div id="notifBadge" class="absolute -top-1 -right-1 text-xs bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center">3</div>
          </div>
          <div class="flex items-center gap-2">
            <img src="https://placehold.co/32x32" class="rounded-full" alt="avatar"/>
            <div class="text-sm">Krish</div>
          </div>
        </div>
      </header>

      <main id="main" class="p-4 overflow-auto h-full">
        <!-- SPA pages will be rendered here -->
      </main>
    </div>
  </div>

  <!-- Policy overlay -->
  <div id="policyOverlay" class="fixed inset-0 bg-black/40 hidden z-50 items-center justify-center">
    <div class="w-11/12 lg:w-3/4 bg-white rounded-2xl shadow-xl overflow-hidden">
      <div class="flex items-center justify-between p-3 border-b">
        <div class="flex items-center gap-3">
          <div class="font-semibold">Policy Viewer</div>
          <div id="policyLiveBadge" class="text-xs text-white bg-amber-500 px-2 py-1 rounded">LIVE UPDATE</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="downloadPolicy" class="px-3 py-1 rounded bg-slate-100">‚¨áÔ∏è Download</button>
          <button id="closeOverlay" class="px-3 py-1 rounded bg-red-50">‚úï Close</button>
        </div>
      </div>
      <div class="flex flex-col lg:flex-row h-[70vh]">
        <div class="lg:w-2/3 h-full border-r">
          <!-- PDF iframe -->
          <iframe id="policyFrame" src="" class="w-full h-full" frameborder="0"></iframe>
        </div>
        <div class="lg:w-1/3 p-3 overflow-auto">
          <div id="policyHeader" class="mb-2">
            <div class="text-sm text-slate-500">Source: <a id="policySource" href="#" target="_blank" class="text-indigo-600 underline">External Link</a></div>
            <div class="text-lg font-semibold mt-1" id="policyTitle">Policy Title</div>
            <div class="text-xs text-slate-400" id="policyEffective">Effective from: ‚Äî</div>
          </div>

          <div class="mt-3">
            <div class="font-medium text-sm">Policy Summary (chat)</div>
            <div id="policyChat" class="mt-2 text-sm bg-slate-50 p-2 rounded h-40 overflow-auto">Loading summary...</div>
            <div class="mt-3">
              <input id="policyQuestion" class="w-full border rounded px-2 py-1 text-sm" placeholder="Ask about this policy..." />
              <div class="mt-2 flex gap-2">
                <button id="askPolicyBtn" class="px-3 py-1 rounded bg-indigo-600 text-white">Ask</button>
                <button id="recheckPolicyBtn" class="px-3 py-1 rounded bg-slate-100">Recheck Updates</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Chatbot -->
  <div id="chatbot" class="fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg bg-rose-600 text-white flex items-center justify-center cursor-pointer z-50">
    <div id="chatIcon">üí¨</div>
  </div>

  <!-- Chat Panel (hidden until opened) -->
  <div id="chatPanel" class="fixed right-6 bottom-6 w-96 bg-white rounded-2xl shadow-xl hidden z-50 overflow-hidden">
    <div class="flex items-center justify-between p-3 border-b">
      <div class="font-semibold">AGENT AVANA - Assistant</div>
      <div class="flex items-center gap-2">
        <button id="minimizeChat" class="px-2">_</button>
        <button id="closeChat" class="px-2">‚úï</button>
      </div>
    </div>
    <div id="chatHistory" class="p-3 h-64 overflow-auto text-sm bg-slate-50"></div>
    <div class="p-3 border-t flex gap-2">
      <input id="chatInput" class="flex-1 border rounded px-2 py-1" placeholder="Ask about clause, verify as of today..." />
      <button id="sendChat" class="px-3 py-1 rounded bg-rose-600 text-white">Send</button>
    </div>
  </div>

  <script>
    // Grab main container early
    const main = document.getElementById('main');

    // ---------------------- MOCK DATA & HELPERS (initialize BEFORE router runs) ----------------------
    let currentDoc = null;
    const mockPolicies = [
      {id:'gst_2024', title:'GST Rules v2024 - Renewal Charges', source:'https://example.com/gst_2024.pdf', effective:'2024-08-01', liveUpdate: false},
      {id:'trade_policy', title:'Trade Policy - Export/Import Guidelines', source:'https://example.com/trade_policy.pdf', effective:'2025-01-01', liveUpdate: true, liveEffective:'2025-10-01'},
      {id:'iso27001', title:'ISO 27001 Summary', source:'https://example.com/iso27001.pdf', effective:'2017-01-01', liveUpdate:false}
    ];

    function percentLabel(p){ return Math.max(0,Math.min(100, Math.round(p)))+'%'; }

    // ---------------------- ROUTER (calls render functions defined below) ----------------------
    function router(){
      const hash = location.hash || '#/';
      if(hash.startsWith('#/verify')) renderVerify();
      else if(hash.startsWith('#/notifications')) renderNotifications();
      else if(hash.startsWith('#/settings')) renderSettings();
      else renderHome();
    }

    window.addEventListener('hashchange', router);

    // ---------------------- HOME PAGE ----------------------
    function renderHome(){
      main.innerHTML = `
        <div class='grid grid-cols-1 lg:grid-cols-3 gap-4'>
          <section class='col-span-1 bg-white p-4 rounded-2xl shadow-sm glass'>
            <h3 class='font-semibold'>Upload / Requirement</h3>
            <p class='text-xs text-slate-500'>Paste requirement text or upload a sample document (PDF/DOCX/Image)</p>
            <div id='dropZone' class='mt-4 border-dashed border-2 border-slate-200 p-4 rounded-lg text-center'>
              <div class='text-slate-400'>Drag & drop a file here or</div>
              <div class='mt-2 flex justify-center gap-2'>
                <input id='fileInput' type='file' class='hidden' />
                <button id='btnChoose' class='px-3 py-2 rounded bg-rose-600 text-white'>Choose file</button>
                <button id='btnSample' class='px-3 py-2 rounded bg-slate-100'>Use sample doc</button>
              </div>
              <div class='mt-3 text-left'>
                <label class='text-xs text-slate-500'>Or paste requirement text:</label>
                <textarea id='reqText' rows='4' class='w-full mt-1 border rounded p-2' placeholder='Example: Vendor agreement that satisfies GST & ISO 27001'></textarea>
              </div>
              <div class='mt-3 flex gap-2'>
                <button id='btnAnalyze' class='px-3 py-2 rounded bg-rose-600 text-white'>Analyze</button>
                <button id='btnPreview' class='px-3 py-2 rounded bg-slate-100'>Preview</button>
                <button id='btnDownloadJSON' class='px-3 py-2 rounded bg-slate-100'>Download JSON</button>
              </div>
            </div>

            <div class='mt-4'>
              <h4 class='text-sm font-medium'>Progress</h4>
              <div class='mt-2'>
                <div class='w-full bg-slate-100 rounded h-4 overflow-hidden'><div id='progressBar' class='h-4' style='width:0%'></div></div>
                <div id='progressPct' class='text-xs text-slate-500 mt-1'>Ready: 0%</div>
              </div>
            </div>

            <div class='mt-4 flex gap-2 items-center'>
              <button id='downloadDoc' class='px-3 py-2 rounded bg-slate-100'>‚¨áÔ∏è Download Doc</button>
              <button id='shareDoc' class='px-3 py-2 rounded bg-slate-100'>üîó Share</button>
            </div>

          </section>

          <section class='col-span-2 bg-white p-4 rounded-2xl shadow-sm'>
            <div class='flex items-start justify-between'>
              <h3 class='font-semibold'>Document Workspace</h3>
              <div class='flex items-center gap-2'>
                <div class='text-xs text-slate-500'>Verification date</div>
                <input type='date' id='verifyDate' class='border rounded px-2 py-1' />
                <button id='btnReverify' class='px-3 py-1 rounded bg-rose-600 text-white'>Reverify</button>
              </div>
            </div>

            <div class='mt-4 grid grid-cols-1 lg:grid-cols-4 gap-4'>
              <div class='lg:col-span-3 p-3 border rounded-lg min-h-[260px]'>
                <div id='docPreview' class='text-sm text-slate-500'>Upload or paste text and click Analyze to begin. (Mock viewer)</div>
              </div>

              <aside class='p-3 border rounded-lg min-h-[260px]'>
                <div class='flex items-center justify-between'>
                  <div class='font-medium'>Policy Matches</div>
                  <div class='text-xs text-slate-400'>Click to open</div>
                </div>
                <div id='policyList' class='mt-3 space-y-2 overflow-auto max-h-56'></div>
              </aside>
            </div>

            <div class='mt-4'>
              <h4 class='font-medium'>Traceability Matrix</h4>
              <div id='traceTable' class='mt-2 overflow-auto text-sm border rounded p-2 max-h-40'>
                <table class='w-full text-left text-xs'>
                  <thead>
                    <tr class='text-slate-500'><th>Clause</th><th>Policy</th><th>Status</th></tr>
                  </thead>
                  <tbody id='traceBody'></tbody>
                </table>
              </div>
            </div>

          </section>
        </div>
      `;

      // wire up elements
      document.getElementById('btnChoose').onclick = ()=> document.getElementById('fileInput').click();
      document.getElementById('btnSample').onclick = ()=> document.getElementById('reqText').value = 'Sample vendor agreement requiring GST compliance and ISO 27001 controls.';
      document.getElementById('fileInput').onchange = (e)=> readFileAsText(e.target.files[0]).then(t=> document.getElementById('reqText').value = t.slice(0,3000));
      document.getElementById('btnAnalyze').onclick = analyzeMock;
      document.getElementById('btnReverify').onclick = reverifyMock;
      document.getElementById('btnDownloadJSON').onclick = downloadJSON;
      document.getElementById('downloadDoc').onclick = ()=> alert('Download endpoint should be wired to POST /api/download');
      document.getElementById('shareDoc').onclick = ()=> navigator.clipboard.writeText(location.href+'#/verify?doc='+ (currentDoc?currentDoc.doc_id:'new_doc')) && alert('Share link copied');

      renderPolicyList();
    }

    function renderPolicyList(){
      const el = document.getElementById('policyList'); el.innerHTML='';
      mockPolicies.forEach(p=>{
        const div = document.createElement('div'); div.className = 'p-2 border rounded hover:bg-slate-50 flex items-center justify-between';
        div.innerHTML = `<div><div class='font-medium'>${p.title}</div><div class='text-xs text-slate-400'>Effective: ${p.effective}</div></div><div class='flex gap-2'><button data-id='${p.id}' class='openPolicy px-2 py-1 rounded bg-slate-100 text-xs'>Open</button><a href='${p.source}' target='_blank' class='px-2 py-1 rounded bg-slate-100 text-xs'>Source</a></div>`;
        el.appendChild(div);
      });
      // Use addEventListener and currentTarget to avoid dataset issues when clicking inner nodes
      document.querySelectorAll('.openPolicy').forEach(b=> b.addEventListener('click', function(e){ openPolicyOverlay(e.currentTarget.dataset.id); }));
    }

    function openPolicyOverlay(policyId){
      const p = mockPolicies.find(x=>x.id===policyId); if(!p) return;
      document.getElementById('policyOverlay').classList.remove('hidden');
      document.getElementById('policyFrame').src = p.source; // In production use GET /api/policy/pdf?policy_id=... to get CORS-friendly URL
      document.getElementById('policyTitle').innerText = p.title;
      document.getElementById('policySource').href = p.source; document.getElementById('policySource').innerText = p.source;
      document.getElementById('policyEffective').innerText = 'Effective from: '+p.effective;
      document.getElementById('policyLiveBadge').style.display = p.liveUpdate ? 'inline-block' : 'none';
      // mock chat summary
      document.getElementById('policyChat').innerText = 'Loading summary...';
      setTimeout(()=>{
        document.getElementById('policyChat').innerText = `Key points:\n- Requirement A applies to vendor fees.\n- Disclosure B must be included in Section 4.\n- Effective changes: see Live Update banner for upcoming changes.`;
      },600);
      // wire overlay buttons
      document.getElementById('closeOverlay').onclick = ()=> document.getElementById('policyOverlay').classList.add('hidden');
      document.getElementById('askPolicyBtn').onclick = async ()=>{
        const q = document.getElementById('policyQuestion').value.trim(); if(!q) return alert('Please type a question');
        // in prod: POST /api/chat {context: policy text, message: q}
        addPolicyChat('You: '+q); setTimeout(()=> addPolicyChat('Assistant: Mock answer ‚Äî refer to clause 4 and GST section.'),500);
      }
      document.getElementById('recheckPolicyBtn').onclick = ()=> alert('This would trigger the Law Updater Agent and show new effective date if available');
      document.getElementById('downloadPolicy').onclick = ()=> window.open(p.source,'_blank');
    }

    function addPolicyChat(text){
      const el = document.getElementById('policyChat');
      el.innerText += '\n\n' + text;
      el.scrollTop = el.scrollHeight;
    }

    // ---------------------- VERIFY PAGE ----------------------
    function renderVerify(){
      main.innerHTML = `
        <div class='bg-white p-4 rounded-2xl shadow-sm'>
          <div class='flex items-center justify-between'>
            <div>
              <h3 class='font-semibold'>Verification Page</h3>
              <div class='text-sm text-slate-500'>Per-clause verification & date-aware checks</div>
            </div>
            <div class='flex items-center gap-2'>
              <input type='date' id='verifyDate2' class='border rounded px-2 py-1' />
              <button id='btnReverify2' class='px-3 py-1 rounded bg-rose-600 text-white'>Reverify</button>
            </div>
          </div>

          <div class='mt-4 grid grid-cols-1 md:grid-cols-3 gap-4'>
            <div class='md:col-span-2'>
              <div id='clausesArea' class='space-y-3'></div>
            </div>
            <aside class='p-3 border rounded-lg'>
              <div class='font-medium'>Document Summary</div>
              <div id='docSummary' class='mt-2 text-sm text-slate-600'>No document loaded.</div>
            </aside>
          </div>
        </div>
      `;
      // mock populate
      const clausesArea = document.getElementById('clausesArea'); clausesArea.innerHTML='';
      if(!currentDoc){ clausesArea.innerHTML = '<div class="text-sm text-slate-400">No document analyzed. Go to Home and Analyze a doc.</div>'; return }
      currentDoc.clauses.forEach(c=>{
        const d = document.createElement('div'); d.className='p-3 border rounded';
        d.innerHTML = `<div class='flex items-start justify-between'><div><div class='font-medium'>${c.original}</div><div class='text-xs text-slate-400'>Type: ${c.type}</div></div><div class='text-sm font-semibold'>${c.status==='satisfied'? '‚úÖ Satisfied' : c.status==='conflict'? '‚ö†Ô∏è Conflict' : '‚ùå Unsatisfied'}</div></div><div class='mt-2 text-xs text-slate-500'>Policy Matches: ${c.matches.map(m=>m.title).join(', ')}</div>`;
        clausesArea.appendChild(d);
      })
      document.getElementById('btnReverify2').onclick = reverifyMock;
    }

    // ---------------------- NOTIFICATIONS ----------------------
    function renderNotifications(){
      main.innerHTML = `
        <div class='bg-white p-4 rounded-2xl shadow-sm'>
          <h3 class='font-semibold'>Notifications</h3>
          <div class='mt-3 space-y-3' id='notifs'>
            <div class='p-3 border rounded'>New GST rule effective <strong>2025-10-01</strong> may affect Clause 2. <button id='act1' class='px-2 py-1 bg-rose-600 text-white rounded text-xs'>Reverify</button></div>
            <div class='p-3 border rounded'>Trade policy updated (2025-09-15). <button class='px-2 py-1 bg-slate-100 rounded text-xs'>View</button></div>
          </div>
        </div>
      `;
      document.getElementById('act1').onclick = ()=>{ location.hash = '#/verify'; setTimeout(()=> alert('Auto-open reverify for impacted doc (mock)')); }
    }

    // ---------------------- SETTINGS ----------------------
    function renderSettings(){
      main.innerHTML = `
        <div class='bg-white p-4 rounded-2xl shadow-sm'>
          <h3 class='font-semibold'>Settings</h3>
          <div class='mt-4 grid grid-cols-1 md:grid-cols-2 gap-4'>
            <div class='p-3 border rounded'>
              <div class='font-medium'>User Preferences</div>
              <div class='mt-2 text-sm'>Language: <select id='prefLang' class='border rounded px-2 py-1'><option>EN</option><option>HI</option></select></div>
            </div>
            <div class='p-3 border rounded'>
              <div class='font-medium'>Policy Sources</div>
              <div class='mt-2 text-sm'>Add or remove policy sources (admin only). Example: Official Gazette URL</div>
            </div>
          </div>
        </div>
      `;
    }

    // ---------------------- MOCK ANALYSIS & VERIFY ----------------------
    function analyzeMock(){
      const text = document.getElementById('reqText').value.trim();
      if(!text){ alert('Paste requirement text or upload a sample.'); return }
      // create mock doc
      currentDoc = {doc_id:'doc_001', title:'Sample Vendor Agreement', clauses: [
        {id:'c1', original:'This agreement auto-renews yearly unless 30 days notice is given', type:'auto_renewal'},
        {id:'c2', original:'Vendor will implement information security controls meeting ISO 27001', type:'security'},
        {id:'c3', original:'Medical software shall comply with IEC 62304', type:'safety'},
        {id:'c4', original:'Quality processes aligned to ISO 9001 will be maintained', type:'quality'}
      ]};

      // mock match
      currentDoc.clauses.forEach(c=>{
        const matches = mockPolicies.filter(p=> (c.type==='security' && p.id.includes('iso27001')) || p.id.includes('gst') || p.id.includes('iso') || p.title.toLowerCase().includes(c.type));
        c.matches = matches.length? matches.map(m=>({policy_id:m.id,title:m.title,score:0.9,effective:m.effective})): [mockPolicies[0]];
        c.status = Math.random()>0.2 ? 'satisfied' : 'unsatisfied';
      });

      // satisfaction score
      const satisfied = currentDoc.clauses.filter(c=>c.status==='satisfied').length;
      const pct = Math.round((satisfied/currentDoc.clauses.length)*100);
      document.getElementById('progressBar').style.width = pct+'%'; document.getElementById('progressPct').innerText = 'Ready: '+percentLabel(pct);

      // render preview / trace
      document.getElementById('docPreview').innerText = 'Document: '+currentDoc.title+' (mock preview)';
      const tb = document.getElementById('traceBody'); tb.innerHTML='';
      currentDoc.clauses.forEach(c=>{
        const tr = document.createElement('tr'); tr.innerHTML = `<td class='py-2'>${c.original.slice(0,80)}...</td><td>${c.matches.map(m=>m.title).join(', ')}</td><td>${c.status==='satisfied'? 'Satisfied' : 'Unsatisfied'}</td>`; tb.appendChild(tr);
      });

      // policy list (match aggregation): show unique policies
      const plist = Array.from(new Set(currentDoc.clauses.flatMap(c=> c.matches.map(m=>m.policy_id))))
        .map(id=> mockPolicies.find(p=>p.id===id) || mockPolicies[0]);
      // re-render policy list with clickable links
      const policyListEl = document.getElementById('policyList'); policyListEl.innerHTML='';
      plist.forEach(p=>{
        const div = document.createElement('div'); div.className='p-2 border rounded hover:bg-slate-50 flex items-center justify-between';
        div.innerHTML = `<div><div class='font-medium'>${p.title}</div><div class='text-xs text-slate-400'>Effective: ${p.effective}</div></div><div class='flex gap-2'><button data-id='${p.id}' class='openPolicy px-2 py-1 rounded bg-slate-100 text-xs'>Open</button><a href='${p.source}' target='_blank' class='px-2 py-1 rounded bg-slate-100 text-xs'>Source</a></div>`;
        policyListEl.appendChild(div);
      });
      document.querySelectorAll('.openPolicy').forEach(b=> b.addEventListener('click', function(e){ openPolicyOverlay(e.currentTarget.dataset.id); }));

      alert('Analysis complete (mock). Progress updated and policy links added. Click any policy to open overlay with full PDF + chat summary.');
    }

    function reverifyMock(){
      if(!currentDoc) return alert('No document loaded');
      // randomize statuses to simulate date-aware outcome
      currentDoc.clauses.forEach(c=>{ if(Math.random()>0.85) c.status='conflict'; else c.status = Math.random()>0.3 ? 'satisfied' : 'unsatisfied'; });
      // update UI if on home
      if(location.hash==='#/' || location.hash===''){
        const satisfied = currentDoc.clauses.filter(c=>c.status==='satisfied').length; const pct = Math.round((satisfied/currentDoc.clauses.length)*100);
        document.getElementById('progressBar').style.width = pct+'%'; document.getElementById('progressPct').innerText = 'Ready: '+percentLabel(pct);
        // update trace table
        const tb = document.getElementById('traceBody'); tb.innerHTML='';
        currentDoc.clauses.forEach(c=>{
          const tr = document.createElement('tr'); tr.innerHTML = `<td class='py-2'>${c.original.slice(0,80)}...</td><td>${c.matches.map(m=>m.title).join(', ')}</td><td>${c.status==='satisfied'? 'Satisfied' : c.status==='conflict'? 'Conflict' : 'Unsatisfied'}</td>`; tb.appendChild(tr);
        });
      }
      alert('Reverification complete (mock).');
    }

    function downloadJSON(){
      if(!currentDoc) return alert('No doc');
      const blob = new Blob([JSON.stringify(currentDoc,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = currentDoc.doc_id + '.json'; a.click(); URL.revokeObjectURL(url);
    }

    // ---------------------- UTIL ----------------------
    function readFileAsText(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsText(file); }) }

    // Chat widget wiring (global)
    const chatbot = document.getElementById('chatbot'); const chatPanel = document.getElementById('chatPanel'); const closeChat = document.getElementById('closeChat'); const minimizeChat = document.getElementById('minimizeChat'); const sendChat = document.getElementById('sendChat'); const chatInput = document.getElementById('chatInput'); const chatHistory = document.getElementById('chatHistory');
    chatbot.onclick = ()=>{ chatbot.style.display='none'; chatPanel.classList.remove('hidden') }
    closeChat.onclick = ()=>{ chatPanel.classList.add('hidden'); chatbot.style.display='flex' }
    minimizeChat.onclick = ()=>{ chatPanel.classList.add('hidden'); chatbot.style.display='flex' }
    sendChat.onclick = ()=>{ const m = chatInput.value.trim(); if(!m) return; addChat('You',m); chatInput.value=''; setTimeout(()=> addChat('Agent Avana','Mock assistant reply ‚Äî integrate POST /api/chat for real answers'),600); }
    function addChat(who,text){ const p=document.createElement('div'); p.className='mb-2'; p.innerHTML=`<div class='text-xs text-slate-400'>${who}</div><div class='p-2 bg-white rounded'>${text}</div>`; chatHistory.appendChild(p); chatHistory.scrollTop = chatHistory.scrollHeight; }

    // ---------------------- INITIALIZE ROUTER & BASIC SMOKE TESTS ----------------------
    // Call router once after all render functions are defined
    router();

    // Basic smoke tests to help catch regressions quickly. These run in-browser and output to console.
    (function runTests(){
      try{
        console.assert(Array.isArray(mockPolicies) && mockPolicies.length>0, 'mockPolicies must be initialized');
        // ensure home renders and policy list is populated
        renderHome();
        const listEl = document.getElementById('policyList');
        console.assert(listEl && listEl.children.length>0, 'policyList should render items');
        console.log('Frontend smoke tests passed');
      }catch(e){ console.error('Frontend smoke tests failed', e); }
    })();
  </script>
</body>
</html>
